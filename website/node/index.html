<!DOCTYPE html>
<html ng-app="app" lang="en" ng-cloak>
  <head>
    <title>Warbands Status</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="shortcut icon" type="image/png" href="favicon.png"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/main.css">
    
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.3/angular.min.js"></script>
    <script src="/js/angular-strap.js"></script>
    <script src="/js/angular-strap-tpls.js"></script>
    <!--<script src="js/angular-panhandler.js"></script> -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/socket.min.js"></script>
    <script src="/js/app.js"></script>
    <script src="/js/arrows.js"></script>
  </head>
  
  <body ng-controller="mainController">
    <div class="container container-forest">
      <!-- Map content -->
      <div class="maps col-xs-12 col-md-9 col-xl-11" ng-show="!settings.forestLayout">
        <!-- Map levels -->
        <div class="mapSpan col-xs-11" ng-class="rowIsOdd(level)" ng-repeat="(level, maps) in maps" ng-show="showRows(level)">
          <div style="float:left;font-size:30px;height:70px;line-height:70px;">
          {{level}}
          </div>
          <!-- List maps -->
          <div 
               popover-append-to-body="true"
               popover-template="mapPopover.templateUrl" 
               popover-title="{{name | fixName}}" 
               popover-trigger="mouseenter" 
               popover-placement="{{level >= 80 ? 'top' : 'bottom'}}" 
               class="map {{map.band}} d{{map.dots}}" 
               ng-repeat="(name, map) in maps" 
               ng-show="showMaps(map, settings.showDots);">
            
            <!--<div style="background-image:url(MapIcon/{{name | fixQuote}}.png);"></div>-->
			<div style="background-position:-{{mapsByName[name].bg_pos+2}}px -2px;"></div>
          </div>
          <!-- /List maps -->
        </div>
        <!-- /Map levels -->
      </div>
      <!-- /Map content -->
	  
<!-- Well shit, this looked promising, but only Chrome can show it apparently :/
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1900" height="850">
  <foreignObject ng-repeat="(name, map) in mapsByName" ng-attr-x="{{map.left}}" ng-attr-y="{{map.top}}" width="1" height="1" class="maps">
    <div id="svg_map_{{name}}" class="map {{maps[map.level][name].band}} d{{maps[map.level][name].dots}}" >
	  <div style="background-position:-{{map.bg_pos}}px 0px;">
	  </div>
    </div>
  </foreignObject>
</svg> -->

      <!-- Toolbox -->
      <div class="toolbox {{settings.forestLayout && 'toolbox-forest' || !settings.forestLayout && 'col-xs-12 col-md-3 col-xl-1'}}" style="{{settings.forestLayout && 'width:'+settings.toolboxWidth+'px;'}}">
        <!-- Toggle Show All/4dots/unknown -->
        <div class="funkyradio" ng-click="search=''">
          <div class="funkyradio-default">
            <input type="radio" name="showDots" ng-model="settings.showDots" value="-1" id="showDots1" checked />
            <label for="showDots1">Show all</label>
          </div>
          <div class="funkyradio-default">
            <input type="radio" name="showDots" ng-model="settings.showDots" value="4" id="showDots2"/>
            <label for="showDots2">Show 4 dots only</label>
          </div>
          <div class="funkyradio-default">
            <input type="radio" name="showDots" ng-model="settings.showDots" value="0" id="showDots3" />
            <label for="showDots3">Show unknown only</label>
          </div>
        </div>
        <!-- /Toggle -->
        <!-- Show current 4dots -->
        <div class="panel panel-default">
          <div class="panel-heading">
            Current 4 dots
          </div>
          <div class="panel-body">
            <p ng-hide="dots4.length">None</p>
            <!--<span ng-repeat="map in dots4" ng-show="dots4.length">{{map | fixName}}<span class='comma'>, </span></span>-->
			<span class="comma-separated-list" ng-repeat="map in dots4" ng-show="dots4.length">{{map | fixName}}</span>
          </div>
        </div>
        <!-- /show current 4 dots -->
        <div class="form-group">
          <input type="text" tabindex="1" ng-model="search" class="form-control" placeholder="Quick search">
        </div>
        <div class="panel panel-default">
          <div class="panel-heading">
            Time until reset
          </div>
          <div class="panel-body">
            {{timeToReset}}
          </div>
        </div>
        <div style="display:inline-block; min-height:290px;width:100%">
          <datepicker ng-model="date" min-date="'7-24-2015'" show-weeks="false" year-range="1" format-day-title="MMMM" class="well well-sm" custom-class="getDayClass(date, mode)">
          </datepicker>
          <div class="form-group">
            <select class="form-control" ng-model="dateHour" ng-init="dateHour = getCurrentTimeslot()">
              <option value="{{(unix | toTimeslot) + n}}" ng-disabled="(unix | toTimeslot) + n > getCurrentTimeslot()" ng-selected="$first" ng-repeat="n in [0,22] | makeRange">{{n<10 ? '0'+n : n}}:00 - {{n+1<10 ? '0'+ (n+1) : n+1}}:00 {{(unix | toTimeslot) + n == getCurrentTimeslot() ? '(Live)' : ''}}</option>
              <option value="{{(unix | toTimeslot) + 23}}" ng-disabled="(unix | toTimeslot) + 23 > getCurrentTimeslot()">23:00 - 00:00 {{(unix | toTimeslot) + n == getCurrentTimeslot() ? '(Live)' : ''}}</option>
            </select>
          </div>
          <div class="form-group" ng-show="dateHour != getCurrentTimeslot()">
            <p>You're currently viewing old Warband cycles.</p>
            <button class="btn btn-danger btn-block" ng-click="autoUpdate = true;date=getCurrentTime();dateHour=getCurrentTimeslot();">View live data</button>
          </div>
        </div>
		<div class="panel panel-default">
		  <button class="btn btn-default btn-sm" style="width:100%;" ng-click="toggleLayout();"><b>Toggle layout</b><br/>Currently layout: <i>{{settings.forestLayout ? 'Forest' : 'List'}}</i></button>
		</div>
      </div>
      <!-- /Toolbox -->
	  
	  <!-- Secondary Layout: Container -->
      <div class="scrollable-maps-container flip" style="position: relative; left: 0px; top: 0px; ">
	    <!-- Dirty trick div, needed just to have the horizontal scrollbar on top instead of bottom, when the window is too small -->
        <div class="flip" style="position: relative; left: 0px; top: 0px; overflow-x: visible; overflow-y: visible; height: 880px;">
	      <!-- Canvas for drawing the arrows -->
		  <canvas id="canvas" class="{{(settings.showDots == -1 && search == '') ? '' : 'canvas-hidden'}}" width="1350" height="850" style="position:absolute; top:0px; left:0px;" ng-show="settings.forestLayout"></canvas>
          <!-- Secondary Layout: Map content -->
          <div id="contentbox" width="1350" height="850" style="position:absolute; top:0px; left:0px" ng-show="settings.forestLayout">
	        <div class="maps">
              <div 
		           ng-dummy="{{map = maps[staticmap.level][name]}} ====> there is probably a more standardized way to do that"
                   popover-append-to-body="true"
                   popover-template="mapPopover.templateUrl" 
                   popover-title="{{name | fixName}}" 
                   popover-trigger="mouseenter" 
                   popover-placement="{{staticmap.left > 0 ? (staticmap.top >= 520 ? 'top' : 'bottom') : 'right'}}" 
                   class="map {{map.band}} d{{map.dots}} {{showMaps(map, settings.showDots) ? '' : 'forest-map-hidden'}}"
                   ng-repeat="(name, staticmap) in mapsByName"
			       style="position:absolute; left: {{staticmap.left*0.7}}px; top: {{staticmap.top}}px;"
			       id="layout2_map_{{name}}" > 
                <div style="background-position:-{{staticmap.bg_pos+2}}px -2px;" id="layout2_map_{{name}}"></div>
              </div>
	        </div>
	      </div>
	      <!-- /Secondary Layout: Map content -->
	    </div>
	  </div>
	  <!-- /Secondary Layout: Container -->
	  
    </div>
  </body>
  
  <script type="text/ng-template" id="mapPopover.html">
    <div>
      <p>Current status: <b>{{map.dots == undefined ? 'No report yet' : map.dots == 0 ? 'Empty' : map.band != 'None' ? map.band : 'Unknown Band,'}}</b><b ng-show="{{map.dots > 0}}"> {{map.dots | pluralize : 'dot'}}</b></p>
      <p ng-hide="{{map.band == 'None' || !map.band}}">Identify: <b>{{bandLoot(map.band)}}</b></p>
      <blockquote style="text-align:left !important" ng-hide="!map.band"><b>{{map.last_report_name}}</b> {{map.last_report_time | betweenParentheses}}<br/><i>{{map.last_report_text}}</i></blockquote>
    </div>
  </script>
  
  
</html>
